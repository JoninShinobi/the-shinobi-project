<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shinobi Project - Simple Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: #667eea;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .entity-selector {
            margin-bottom: 20px;
        }
        .entity-selector select {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .data-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .data-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .ai-button {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .ai-insights {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ¥· The Shinobi Project - Simple Dashboard</h1>
        <p>Business Management System</p>
    </div>

    <div class="entity-selector">
        <select id="entitySelector" onchange="updateDashboard()">
            <option value="">All Entities (Overview)</option>
            {% for org in organizations %}
            <option value="{{ org.id }}" {% if org.id == selected_entity_id %}selected{% endif %}>
                {{ org.name }}
            </option>
            {% endfor %}
            {% for person in individuals %}
            <option value="{{ person.id }}" {% if person.id == selected_entity_id %}selected{% endif %}>
                {{ person.name }}
            </option>
            {% endfor %}
        </select>
        <button class="ai-button" onclick="getAIInsights()">ðŸ¤– AI Insights</button>
    </div>

    {% if selected_entity_id %}
        <!-- Entity-specific view -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ entity.name }}</div>
                <div>{{ entity_type_display }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ relationships.total }}</div>
                <div>Relationships</div>
            </div>
            {% if entity.entity_type == 'organization' %}
                <div class="stat-card">
                    <div class="stat-number">{{ primary_projects|length }}</div>
                    <div>Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ time_entries|length }}</div>
                    <div>Time Entries</div>
                </div>
            {% elif entity.entity_type == 'individual' %}
                <div class="stat-card">
                    <div class="stat-number">{{ time_entries|length }}</div>
                    <div>Time Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ assigned_tasks|length }}</div>
                    <div>Assigned Tasks</div>
                </div>
            {% endif %}
        </div>

        <!-- Recent Time Entries -->
        {% if time_entries %}
        <div class="data-section">
            <h3>Recent Time Entries</h3>
            {% for entry in time_entries %}
            <div class="data-item">
                <strong>{{ entry.organization.name|default:"General" }}</strong><br>
                {{ entry.description }}<br>
                <small>{{ entry.start_time|date:"M d, H:i" }} - {{ entry.duration|default:"Ongoing" }}</small>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Projects -->
        {% if primary_projects %}
        <div class="data-section">
            <h3>Projects</h3>
            {% for project in primary_projects %}
            <div class="data-item">
                <strong>{{ project.name }}</strong><br>
                {{ project.description }}<br>
                <small>Status: {{ project.status }}</small>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Tasks -->
        {% if assigned_tasks %}
        <div class="data-section">
            <h3>Assigned Tasks</h3>
            {% for task in assigned_tasks %}
            <div class="data-item">
                <strong>{{ task.title }}</strong><br>
                {{ task.description }}<br>
                <small>Priority: {{ task.priority }} | Status: {{ task.status }}</small>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Relationships -->
        <div class="data-section">
            <h3>Relationships ({{ relationships.total }})</h3>
            {% for rel in relationships.outgoing %}
            <div class="data-item">
                <strong>{{ rel.relationship_type }}</strong> {{ rel.entity_b.name }}
                <small>(Strength: {{ rel.strength }}/10)</small>
            </div>
            {% endfor %}
            {% for rel in relationships.incoming %}
            <div class="data-item">
                <strong>{{ rel.entity_a.name }}</strong> {{ rel.relationship_type }} this entity
                <small>(Strength: {{ rel.strength }}/10)</small>
            </div>
            {% endfor %}
        </div>

    {% else %}
        <!-- Overview -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ total_entities }}</div>
                <div>Total Entities</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_organizations }}</div>
                <div>Organizations</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_time_entries }}</div>
                <div>Time Entries</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_tasks }}</div>
                <div>Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_projects }}</div>
                <div>Projects</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_relationships }}</div>
                <div>Relationships</div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="data-section">
            <h3>Recent Time Entries</h3>
            {% for entry in recent_time_entries %}
            <div class="data-item">
                <strong>{{ entry.person.name }}</strong> - {{ entry.organization.name|default:"General" }}<br>
                {{ entry.description }}<br>
                <small>{{ entry.start_time|date:"M d, H:i" }}</small>
            </div>
            {% endfor %}
        </div>

        <div class="data-section">
            <h3>Recent Tasks</h3>
            {% for task in recent_tasks %}
            <div class="data-item">
                <strong>{{ task.title }}</strong><br>
                {{ task.description }}<br>
                <small>Priority: {{ task.priority }} | Status: {{ task.status }}</small>
            </div>
            {% endfor %}
        </div>

        <div class="data-section">
            <h3>Top Organizations by Activity</h3>
            {% for org in top_organizations %}
            <div class="data-item">
                <strong>{{ org.name }}</strong><br>
                Time entries: {{ org.time_entries_count }} | Projects: {{ org.projects_count }}
            </div>
            {% endfor %}
        </div>
    {% endif %}

    <div id="aiInsights" class="ai-insights">
        <h3>ðŸ¤– AI Business Intelligence</h3>
        <div id="aiContent">Loading insights...</div>
    </div>

    <script>
        function updateDashboard() {
            const entityId = document.getElementById('entitySelector').value;
            const url = entityId ? 
                `?entity_id=${entityId}` : 
                window.location.pathname;
            window.location.href = url;
        }

        function getAIInsights() {
            const entityId = document.getElementById('entitySelector').value;
            const insightsDiv = document.getElementById('aiInsights');
            const contentDiv = document.getElementById('aiContent');
            
            insightsDiv.style.display = 'block';
            contentDiv.innerHTML = 'Loading AI insights...';
            
            // Simple fetch to get AI insights
            const url = entityId ? 
                `/api/ai-insights/${entityId}/` : 
                '/api/ai-insights/overview/';
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let html = '<h4>Analysis Results:</h4>';
                        if (data.insights.analysis) {
                            html += '<pre>' + JSON.stringify(data.insights.analysis, null, 2) + '</pre>';
                        } else {
                            html += '<p>' + JSON.stringify(data.insights) + '</p>';
                        }
                        contentDiv.innerHTML = html;
                    } else {
                        contentDiv.innerHTML = '<p>Error: ' + data.error + '</p>';
                    }
                })
                .catch(error => {
                    contentDiv.innerHTML = '<p>Error loading insights: ' + error + '</p>';
                });
        }
    </script>
</body>
</html>